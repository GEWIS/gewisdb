services:
    nginx:
        image: abc.docker-registry.gewis.nl/db/gewisdb/nginx:latest
        env_file:
            - .env
        #        environment:
        #            - NGINX_REQUIRE_AUTH=
        depends_on:
            - web
        volumes:
            - public:/code/public:ro,cached
            - logs-nginx:/etc/nginx/logs:rw
        networks:
            - network
        # ports:
        #     - "9725:9725"
        restart: unless-stopped
    web:
        image: abc.docker-registry.gewis.nl/db/gewisdb/web:production
        # env_file:
        #     - .env
        environment:
            - APP_ENV=${APP_ENV}
            - APP_URL=${APP_URL}
            - CHECKER_MEMBERSHIP_API_ENDPOINT=${CHECKER_MEMBERSHIP_API_ENDPOINT}
            - CHECKER_MEMBERSHIP_API_KEY=${CHECKER_MEMBERSHIP_API_KEY}
            - CHECKER_MEMBERSHIP_API_MAX_MANUAL_REQUESTS=${CHECKER_MEMBERSHIP_API_MAX_MANUAL_REQUESTS}
            - CHECKER_MEMBERSHIP_API_MAX_TOTAL_REQUESTS=${CHECKER_MEMBERSHIP_API_MAX_TOTAL_REQUESTS}
            - COOKIE_DOMAIN=${COOKIE_DOMAIN}
            - DEMO_CREDENTIALS_PASSWORD=${DEMO_CREDENTIALS_PASSWORD}
            - DEMO_CREDENTIALS_USERNAME=${DEMO_CREDENTIALS_USERNAME}
            - DOCTRINE_DEFAULT_DATABASE=${DOCTRINE_DEFAULT_DATABASE}
            - DOCTRINE_DEFAULT_HOST=${DOCTRINE_DEFAULT_HOST}
            - DOCTRINE_DEFAULT_PASSWORD=${DOCTRINE_DEFAULT_PASSWORD}
            - DOCTRINE_DEFAULT_PORT=${DOCTRINE_DEFAULT_PORT}
            - DOCTRINE_DEFAULT_ROLE=${DOCTRINE_DEFAULT_ROLE}
            - DOCTRINE_DEFAULT_USER=${DOCTRINE_DEFAULT_USER}
            - DOCTRINE_REPORT_DATABASE=${DOCTRINE_REPORT_DATABASE}
            - DOCTRINE_REPORT_HOST=${DOCTRINE_REPORT_HOST}
            - DOCTRINE_REPORT_PASSWORD=${DOCTRINE_REPORT_PASSWORD}
            - DOCTRINE_REPORT_PORT=${DOCTRINE_REPORT_PORT}
            - DOCTRINE_REPORT_ROLE=${DOCTRINE_REPORT_ROLE}
            - DOCTRINE_REPORT_USER=${DOCTRINE_REPORT_USER}
            - LDAP_BASEDN=${LDAP_BASEDN}
            - LDAP_BINDUSER_PASS=${LDAP_BINDUSER_PASS}
            - LDAP_BINDUSER_USERNAME=${LDAP_BINDUSER_USERNAME}
            - LDAP_DOMAIN=${LDAP_DOMAIN}
            - LDAP_FILTER=${LDAP_FILTER}
            - LDAP_SERVERS=${LDAP_SERVERS}
            - LDAP_STARTTLS=${LDAP_STARTTLS}
            - MAIL_FROM_ADDRESS=${MAIL_FROM_ADDRESS}
            - MAIL_FROM_NAME=${MAIL_FROM_NAME}
            - MAIL_FROM_SECRETARY_ADDRESS=${MAIL_FROM_SECRETARY_ADDRESS}
            - MAIL_FROM_SECRETARY_NAME=${MAIL_FROM_SECRETARY_NAME}
            - MAIL_TO_CHECKER_RESULT_ADDRESS=${MAIL_TO_CHECKER_RESULT_ADDRESS}
            - MAIL_TO_CHECKER_RESULT_NAME=${MAIL_TO_CHECKER_RESULT_NAME}
            - MAIL_TO_REPORT_ERROR_ADDRESS=${MAIL_TO_REPORT_ERROR_ADDRESS}
            - MAIL_TO_REPORT_ERROR_NAME=${MAIL_TO_REPORT_ERROR_NAME}
            - MAIL_TO_SUBSCRIPTION_ADDRESS=${MAIL_TO_SUBSCRIPTION_ADDRESS}
            - MAIL_TO_SUBSCRIPTION_NAME=${MAIL_TO_SUBSCRIPTION_NAME}
            - MAILMAN_API_ENDPOINT=${MAILMAN_API_ENDPOINT}
            - MAILMAN_API_VERSION=${MAILMAN_API_VERSION}
            - MAILMAN_API_USERNAME=${MAILMAN_API_USERNAME}
            - MAILMAN_API_PASSWORD=${MAILMAN_API_PASSWORD}
            - PHP_IDE_CONFIG=${PHP_IDE_CONFIG}
            - STRIPE_API_VERSION=${STRIPE_API_VERSION}
            - STRIPE_CANCEL_URL=${STRIPE_CANCEL_URL}
            - STRIPE_MEMBERSHIP_PRICE_ID=${STRIPE_MEMBERSHIP_PRICE_ID}
            - STRIPE_PUBLISHABLE_KEY=${STRIPE_PUBLISHABLE_KEY}
            - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
            - STRIPE_SUCCESS_URL=${STRIPE_SUCCESS_URL}
            - STRIPE_WEBHOOK_SIGNING_KEY=${STRIPE_WEBHOOK_SIGNING_KEY}
        depends_on:
            - postfix
        volumes:
            - logs-web:/data/logs:rw
            - public:/code/public:rw,cached
        networks:
            - network
        restart: unless-stopped
    postfix:
        image: juanluisbaptiste/postfix
        env_file:
            - .env
#        environment:
#            - SMTP_SERVER=
#            - SMTP_PORT=
#            - SMTP_USERNAME=
#            - SMTP_PASSWORD=
#            - SERVER_HOSTNAME=
        networks:
            - network
        expose:
            - 1025
        restart: unless-stopped
        stop_grace_period: 60s

volumes:
    logs-web:
    logs-nginx:
    public:

networks:
    network:
